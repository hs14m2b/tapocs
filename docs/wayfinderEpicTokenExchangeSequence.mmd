---
title: Sequence diagram for Token Exchange role within Wayfinder and Epic integration
description: Sequence diagram showing the process of token exchange between Wayfinder and Epic systems, using NHS login.
author: Matthew Brown
date: 2025-08-01
tags: [Wayfinder, Epic, Token Exchange, Sequence Diagram]
displayMode: sequence
config:
  theme: default
  look: handdrawn
---


sequenceDiagram
    actor P as Patient
    participant NHSA as NHS App
    participant PCA as Wayfinder Patient Care Aggregator
    participant WFR as Wayfinder relationship store
    participant EPIC as Epic FHIR Server
    participant PEP as Other Patient Engagement Platform/EPR
    participant EOIDC as Epic OIDC Server
    participant NHSLT as NHS Login Token Endpoint
    note over P: Patient uses NHS App<br />to retrieve list of appointments
    P->>NHSA: Launches Wayfinder within NHS App
    NHSA->>+PCA: Request list of appointments using FHIR
    %% see https://simplifier.net/nhsbookingandreferrals/~resources?category=Example&exampletype=Bundle&sortBy=DisplayName for example messages
    PCA->>WFR: Request patient relationship information
    WFR-->>PCA: Return patient relationship with Epic
    par for all relationships
      alt Relationship with Epic
        PCA->>+NHSLT: Request OAuth2.0 token exchange using NHS Login identity token
        NHSLT<<->>NHSLT: Validate NHS Login identity token
        NHSLT-->>-PCA: Return new NHS login access and identity tokens to Patient Care Aggregator
        note over PCA: Patient Care Aggregator now has<br />NHS Login access and identity tokens
        PCA->>+EOIDC: Request access token using OIDC, passing NHS Login identity token from Patient Care Aggregator
        EOIDC->>+NHSLT: Request OAuth2.0 token exchange using NHS Login identity token
        NHSLT<<->>NHSLT: Validate NHS Login identity token
        NHSLT-->>-EOIDC: Return new NHS login access and identity tokens to Epic
        EOIDC-->>-PCA: Return new Epic access token (patient context) to Patient Care Aggregator
        PCA->>+EPIC: Request list of appointments using FHIR with Epic access token (patient context)
        EPIC-->>-PCA: Return list of appointments (patient context)
      else Relationship with another EPR/PEP
        PCA->>+PEP: Request list of appointments using FHIR secured with TLS-MA
        PEP-->>-PCA: Return list of appointments
      end
    end
    PCA-->>PCA: Aggregate list of appointments
    PCA-->>-NHSA: Return list of appointments (patient context)
    NHSA-->>P: Return list of appointments (patient context)
