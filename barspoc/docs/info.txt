Purpose - PoC to act as both BaRS Provider and BaRS Consumer for basic appointment management

Using INT environment - setup for certificates etc located at https://simplifier.net/guide/nhsbookingandreferralstandard/Home/Build/Testing-and-Environments?version=1.8.1#onboarding

Domain for BaRS supplier - BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk
Requesting certificate and domain - needs domain first with arbitraty CNAME entry - this then allows certificate to be created. 
Certificate is then used to create the custom domain name in API GW - which provides the actual domain name to which the original DNS entry needs a CNAME entry to.

creating a CSR for certificate
openssl genrsa -out BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.key 2048
openssl req -new -key BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.key -out BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.csr

Certificate and Domain requested 25/1/25

Certificate issued by ITOC - see https://digital.nhs.uk/services/path-to-live-environments/path-to-live-forms/combined-endpoint-and-service-registration-request
DNS entry issued by DNS team (email team with details - don't need domain before getting certificate)

Merging crt and key (in case need to load client cert into cert store on laptop)
certutil -mergepfx BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.crt BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.pfx  -- this allows browser based access using client cert.


plain TLS
curl -v https://int-barspoc-barspocbe.nhsdta.com/barspoc/FHIR/R4/Appointment/1234

curl -v https://t6tc3zwi42.execute-api.eu-west-2.amazonaws.com/barspoc/fhir/r4/Appointment/4a3836f5-2d42-4d3e-87c1-680173b7fa5c

TLSMA

curl -vk https://BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk/barspoc/FHIR/R4/Appointment?patient%3Aidentifier=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C6700028191 --cert ../certs/testclient/internal-dev.proxy.nirpoc.nhsesolarch.nhs.uk.crt --key ../certs/testclient/internal-dev.proxy.nirpoc.nhsesolarch.nhs.uk.key
curl -vk https://BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk/barspoc/FHIR/R4/Appointment?patient%3Aidentifier=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C6700028191 --cert ../certs/mhdtest001.key.pub --key ../certs/mhdtest001.key
curl -vk https://BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk/barspoc/FHIR/R4/Appointment?patient%3Aidentifier=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C9661034524 --cert ../certs/testclient/diagnosticRepProxy.crt --key ../certs/testclient/diagnosticRepProxy.key

#with BaRS certificate
curl -vk https://bars-int-x26.tsassolarch.thirdparty.nhs.uk/barspoc/FHIR/R4/Appointment/4a3836f5-2d42-4d3e-87c1-680173b7fa5c --cert ../certs/BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.crt --key ../certs/BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.key

curl -vk https://bars-int-x26.tsassolarch.thirdparty.nhs.uk/barspoc/fhir/r4/Appointment/4a3836f5-2d42-4d3e-87c1-680173b7fa5c --cert ../certs/BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.crt --key ../certs/BaRS-INT-X26.TSASSolArch.thirdparty.nhs.uk.key

HTTP API Gateway configuration:
- load the certificate for the custom domain into AWS Cert Manager
- For API Gateway need to have a "verification" certificate issued by AWS, with DNS verification to prove ownership of the domain.
  - in AWS Certificate Manager - request a new public certificate in the relevant domain name (bars-int-x26.tsassolarch.thirdparty.nhs.uk) 
  - AWS then requires a CNAME record to be created in a random subdomain - send this request to DNS team
- create a Custom Domain which links the certificate - note the AWS DNS name for the custom domain name (e.g. d-cwm1q2lhll.execute-api.eu-west-2.amazonaws.com) 
    - note - this is different to the "normal" domain name for the API (e.g. cs4cbdgvl9.execute-api.eu-west-2.amazonaws.com)
- create a CNAME record for the actual domain pointing to the Custom Domain name domain - all should now work OK
  - e.g. bars-int-x26.tsassolarch.thirdparty.nhs.uk. 3600 IN CNAME d-cwm1q2lhll.execute-api.eu-west-2.amazonaws.com.



BaRS Receiver set up in INT as follows (manual process - emailing the BaRS team with Base URL information):
"matthewbrown":"https://bars-int-x26.tsassolarch.thirdparty.nhs.uk/barspoc/fhir/r4"â€‚

So will need as an "identifier" in DocumentReference resources
{"system":"https://fhir.nhs.uk/Id/dos-service-id","value":"matthewbrown"}

Base64 encoded = eyJzeXN0ZW0iOiJodHRwczovL2ZoaXIubmhzLnVrL0lkL2Rvcy1zZXJ2aWNlLWlkIiwidmFsdWUiOiJtYXR0aGV3YnJvd24ifQ==

So the header you need (along with the others) is
NHSD-Target-Identifier: eyJzeXN0ZW0iOiJodHRwczovL2ZoaXIubmhzLnVrL0lkL2Rvcy1zZXJ2aWNlLWlkIiwidmFsdWUiOiJtYXR0aGV3YnJvd24ifQ==
when invoking the BaRS proxy

NRL information
Valuesets contained in code in github repo as follows:
https://github.com/NHSDigital/NRLF/tree/develop/resources/fhir

URL to create API-M client apps in the non-prod instance (e.g. internal-dev etc)
https://dos-internal.ptl.api.platform.nhs.uk/MyApplications
https://apigee.com/organizations/nhsd-nonprod/apps

Instructions for NHS login mock in INT environment.
https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/testing-with-our-mock-authorisation-service-using-nhs-login---separate-authentication

Getting client id
curl --location --request GET 'https://int.api.service.nhs.uk/mock-jwks/keycloak-client-credentials' --header 'apikey: JE4ESpy5NzFyG5n4U6pKqk8HGXeRjLhZ'
this returns
{
  "cis2": {"client_id":"pytest-nhsd-apim","client_secret":"8af96060-a045-4ccf-9069-aa70cef39a6f","redirect_uri":"https://example.org"}, 
  "nhs-login": {"client_id":"pytest-nhsd-apim","client_secret":"8332c425-d69e-46ef-9241-69998fa81018","redirect_uri":"https://example.org"} }

Launching authentication
client_id = pytest-nhsd-apim
client_secret = 8332c425-d69e-46ef-9241-69998fa81018
redirect_uri = https://example.org

https://identity.ptl.api.platform.nhs.uk/realms/NHS-Login-mock-int/protocol/openid-connect/auth?scope=openid+profile+email+phone&response_type=code&client_id=pytest-nhsd-apim&redirect_uri=https://example.org

see https://nhsd-confluence.digital.nhs.uk/spaces/APM/pages/373753197/Testing+with+mock+auth#Testingwithmockauth-NHSLogintestusers
for usernames
example username is 9912003071

CODE=da357217-c5e5-49a1-b1e1-a963f6d98ca0.58b0daf6-69bd-4fd9-9d10-7904a462dfc0.a22889a8-598c-4df3-84d7-aef718490095
token endpoint
curl --location --request POST 'https://identity.ptl.api.platform.nhs.uk/realms/NHS-Login-mock-int/protocol/openid-connect/token'  --header 'Content-Type: application/x-www-form-urlencoded'  --data-urlencode 'scope=openid profile email phone' --data-urlencode 'grant_type=authorization_code'  --data-urlencode 'code=1f70bc6d-ebbd-444c-bb8b-cf65057530c3.58b0daf6-69bd-4fd9-9d10-7904a462dfc0.a22889a8-598c-4df3-84d7-aef718490095'  --data-urlencode 'redirect_uri=https://example.org' --data-urlencode 'client_id=pytest-nhsd-apim' --data-urlencode 'client_secret=8332c425-d69e-46ef-9241-69998fa81018'

userinfo endpoint
curl --location --request GET 'https://identity.ptl.api.platform.nhs.uk/realms/NHS-Login-mock-int/protocol/openid-connect/userinfo' --header 'Authorization: Bearer eyJhbGciOiJSUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJCODZ6R3JmY29sb08xM3JuaktZRHlBSmNxajJpWkFNclM0OWp5bGVMMEZvIn0.eyJleHAiOjE3NDAxNzI5NjEsImlhdCI6MTc0MDE3MjY2MSwiYXV0aF90aW1lIjoxNzQwMTcyNjI1LCJqdGkiOiI0Yzc4MGI5OC04ZTVlLTQxMTUtYmE4Yi1mYTZhZDExNDRjMGUiLCJpc3MiOiJodHRwczovL2lkZW50aXR5LnB0bC5hcGkucGxhdGZvcm0ubmhzLnVrL3JlYWxtcy9OSFMtTG9naW4tbW9jay1pbnQiLCJzdWIiOiI5YzJiMzVjNi0zMzZkLTQwZGMtOTA4Yi03ZmJkYTJmYmJlOWEiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJweXRlc3QtbmhzZC1hcGltIiwic2Vzc2lvbl9zdGF0ZSI6IjZmZDE2NTczLTQxZmYtNGQ0Zi04NTFkLTZkZDAwYzIxODJiNyIsInNjb3BlIjoicHJvZmlsZSBvcGVuaWQgcGhvbmUgbmhzX251bWJlciBlbWFpbCIsInNpZCI6IjZmZDE2NTczLTQxZmYtNGQ0Zi04NTFkLTZkZDAwYzIxODJiNyIsImlkX3N0YXR1cyI6InZlcmlmaWVkIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm9kc19jb2RlIjoiUkVQQyIsImlkZW50aXR5X3Byb29maW5nX2xldmVsIjoiUDkiLCJ2dG0iOiJodHRwczovL2F1dGguc2FuZHBpdC5zaWduaW4ubmhzLnVrL3RydXN0bWFyay9hdXRoLnNhbmRwaXQuc2lnbmluLm5ocy51ayJ9.J6pY0wTCiSThPBhsuZRwAo2wu3GCewoEhJ-8-1iMau9lO8G8qiGi9ApOkRFxy8Ct13d6HuuEXPpipXN0kxD-SnqWOEMPXG9damMxn5e0CzrlPa_LByQy-owrVW6Twjg5RjC7uWhTtu2ccSDa2VSWZjzOqxZTdH9QVzq05CVxHsCcOje_SkyeGIN9ZndTBnXVT4W0zKOzW7nvhstBLNpMRS3-KctKWfpVQvaGI2D0wIBji5G4g2lwCAd9IlYqNOvV1NLxem4rkVeh9wIY6BzCm5OxdYHD9ArsNo03OUtj9PYCMW3B5_A6J_dXGk8tcFEOXFTBpQEyfuJIShi_VDUgDi2nrVQN5CtGPVZGCtintKY9HccQEMQZlQC7sQWXhvz5hyv6j9DFBgztb3zYD5biblYL7WN2IaOHo0bo2KEyk5P4TDKWHSHVnlXTF7jJ4ycfzUaILyZR5axUU9OX819eQNHNVANq0NVRN982aep1bW5lwXFnqvY25yZkBtETTloZlfBPsjDsJw06SoRyGoEpSN_x_bBzUhbBGWgCCij169F1_Q9DTONcqLTFDqZ8rpWLHoS-CRjfBrGwtbyGy39Mw5eLXVRSxC0B5B6ipGJeoIW5FdVVlXXCoAPIjB6nWkLRkk8XR-HonSMYEF8mqisGYbnuwQnIWLCqXH5moGjJaXs'

URL for mock UI - https://main-mabr8-barspocui-nextjsfe.nhsdta.com

Wayfinder definition for appointment on simplifier
https://simplifier.net/wayfinder-patient-care-aggregator/wayfinderukcoreappointment

BaRS definition is
https://simplifier.net/HL7FHIRUKCoreR4/UKCore-Appointment

see also
https://github.com/NHSDigital/nhse-epr-integration
